# OpenVPN AD integration
### Machine level VPN using ADCS-issued certificates

This is intended to be a machine-level OpenVPN setup that 'just works' â€¦ during the work hours that we specify.
It was designed for use with OpenVPN on a pfSense firewall, using an AD-CS Certificate Authority
It provides machine-level VPN connectivity for domain computers, for always-on AD domain connection, using non-exportable certificates
Logon hours can be limited, where the computer is actively disconnected from the VPN after hours.

The VPN runs as a system service, and as such, does not show up in the OpenVPN GUI. The setup script puts shortcuts for service start/stop, and log view in the start menu, under OpenVPN. The service permissions are altered to allow regular users to start and stop the VPN manually. They are not allowed to disable/enable it. When off business hours, the VPN service is disabled, and can only be enabled by an administrator or the system.

## Requirements
- A pfSense firewall running OpenVPN
- An AD CS Certificate Authority which autoenrolls domain computers with web client certificates 
- OCSP running in your certificate infrastructure, so that the firewall can check certificate revocation 
- An RMM or deployment tool for mass deployment
- A good brain to figure out everything i'm missing in this unfinished documentation

## Notes
- To limit connection hours, client computer users must not be local admin
- the scripts are set to run from %programdata%\corpvpn
- If you wish to change this folder, will need to change $install_path in a few scripts, and update the task xml files

## Setup

** This is very very under construction **
1. Generate an exportable Server certificate on our AD CA, and import it + the CA cert to your pfSense firewall
2. Create an OpenVPN server on your pfSense. Any unspecified settings can be left as default or changed as you see fit:
- Server mode: Remote Access (SSL/TLS)
- Use a TLS key: checked (copy and paste this key into static.key)
- Peer Certificate Authority: The AD CA that you imported
- OCSP Check: checked
- OCSP URL: the url to your OCSP server (http://your.server/ocsp)
- Server Certificate: the server certificate you imported
- Enforce Key Usage: checked
- DNS Default Domain: your AD domain
- DNS Server enable: checked
- DNS Server 1/2/etc: your AD DNS servers
- Block outside DNS: checked (this is a good way to ensure remote users have the same degree of DNS protection that users in the office have)
- Force DNS cache update: checked
- Gateway creation: IPv4 only
- Verbosity level: default (turn up to 4 if you need to troubleshoot)
3. Configure appropriate firewall rules. (You can use a package like pfBlocker to limit access to specific countries)
4. Edit $conf in oVPN_setup.ps1, filling in your openVPN servers address/port info, Cert / CA info, business hours, and an AD group for 24x7 access
5. Copy the contents of the corpvpn folder to c:\programdata\corpvpn
6. Install OpenVPN
7. run oVPN_setup.ps1

## Config files
### corpvpn\config_params.json
- Auto-generated by the setup script, used by all scheduled scripts
- Contains server address / port info, certificate / CA info, anything specific to your setup
- Customize oVPN_setup.ps1 to change these settings

## Scripts:
### OpenVPN config generation script
#### Description
- the ps1 script reads config.ovpn.template, and generates a new OpenVPN config, using the contents of config_params.json + static.key. 
- It needs to rerun periodically to ensure the current certificate in use.
#### Components
- corpvpn\generate_ovpn_config.ps1
- corpvpn\config.ovpn.template
- corpvpn\static.key
#### Scheduled task
- Monthly

### Network check on interface up script
#### Description
- Script is triggerred via scheduled task, whenever a network interface goes up, to check if the computer is currently connected to the office network or not.
- If the network name matches the the computers domain, then the vpn is disabled. If not, then its enabled
- The XML file is the task itself, which is imported via schtasks.exe
#### Components
- corpvpn\ifup.ps1
- corpvpn\ifup_task.xml
#### Scheduled task
- On windows event: Microsoft-Windows-NetworkProfile/Operational, event id 10000

### Office hours enforcement script
#### Description
- The script checks the time, and disables the VPN service if outside of office hours + the user is not a domain admin / part of the 24x7 group
#### Components
- enforce_office_hours.ps1
- enforce_on_unlock_task.xml
#### Scheduled tasks
- At start and end times specified in oVPN_setup.ps1
- on computer unlock/account session connection
